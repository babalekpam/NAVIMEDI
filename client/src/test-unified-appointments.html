<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ Unified Appointment System Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; color: #2d3748; }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .section h2 { color: #2b6cb0; margin: 0 0 15px 0; }
        .btn {
            margin: 8px 5px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #3182ce; color: white; }
        .btn-primary:hover { background: #2c5aa0; }
        .btn-success { background: #38a169; color: white; }
        .btn-success:hover { background: #2f855a; }
        .btn-warning { background: #d69e2e; color: white; }
        .btn-warning:hover { background: #b7791f; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-danger:hover { background: #c53030; }
        .logs { 
            background: #1a202c; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 8px;
            max-height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 15px 0;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .appointment-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #3182ce;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .appointment-meta { font-size: 0.85em; color: #718096; margin-top: 8px; }
        .success { color: #38a169; }
        .error { color: #e53e3e; }
        .warning { color: #d69e2e; }
        .info { color: #3182ce; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ Unified Appointment System Test</h1>
            <p>Testing real-time synchronization between Patient Portal, Doctor Portal, and Receptionist Dashboard</p>
        </div>

        <!-- Statistics Dashboard -->
        <div class="section">
            <h2>ğŸ“Š System Status</h2>
            <div class="stats">
                <div class="stat-box">
                    <div id="totalCount" class="stat-number">0</div>
                    <div class="stat-label">Total Appointments</div>
                </div>
                <div class="stat-box">
                    <div id="drSmithCount" class="stat-number">0</div>
                    <div class="stat-label">Dr. Smith's Appointments</div>
                </div>
                <div class="stat-box">
                    <div id="sarahCount" class="stat-number">0</div>
                    <div class="stat-label">Sarah Williams' Appointments</div>
                </div>
                <div class="stat-box">
                    <div id="todayCount" class="stat-number">0</div>
                    <div class="stat-label">Today's Appointments</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="refreshStats()">ğŸ”„ Refresh Statistics</button>
            <button class="btn btn-danger" onclick="clearAllAppointments()">ğŸ—‘ï¸ Clear All Data</button>
        </div>

        <!-- Test Actions -->
        <div class="section">
            <h2>ğŸ§ª Create Test Appointments</h2>
            <p>Test the unified system by creating appointments from different user types:</p>
            
            <div style="margin: 15px 0;">
                <h3>ğŸ‘¤ Patient Portal Simulation</h3>
                <button class="btn btn-success" onclick="createPatientAppointment()">
                    ğŸ“± Book as Patient (Sarah Williams)
                </button>
                <button class="btn btn-success" onclick="createPatientAppointmentDifferentDoctor()">
                    ğŸ“± Book with Dr. Brown
                </button>
            </div>

            <div style="margin: 15px 0;">
                <h3>ğŸ‘¨â€âš•ï¸ Doctor Portal Simulation</h3>
                <button class="btn btn-primary" onclick="createDoctorAppointment()">
                    ğŸ©º Schedule as Dr. Smith
                </button>
                <button class="btn btn-primary" onclick="createDoctorEmergencyAppointment()">
                    ğŸš¨ Emergency Appointment (Dr. Smith)
                </button>
            </div>

            <div style="margin: 15px 0;">
                <h3>ğŸ¢ Receptionist Dashboard Simulation</h3>
                <button class="btn btn-warning" onclick="createReceptionistAppointment()">
                    ğŸ“‹ Schedule as Receptionist
                </button>
                <button class="btn btn-warning" onclick="createReceptionistUrgentAppointment()">
                    âš ï¸ Urgent Appointment (Receptionist)
                </button>
            </div>
        </div>

        <!-- Current Appointments Display -->
        <div class="section">
            <h2>ğŸ“… Current Appointments</h2>
            <div id="appointmentsList"></div>
        </div>

        <!-- Test Portal Links -->
        <div class="section">
            <h2>ğŸ”— Test in Actual Portals</h2>
            <p>After creating appointments above, test them in the real portals:</p>
            <a href="/patient-portal" target="_blank" class="btn btn-success">
                ğŸ‘¤ Open Patient Portal
            </a>
            <a href="/doctor-portal-fixed" target="_blank" class="btn btn-primary">
                ğŸ‘¨â€âš•ï¸ Open Doctor Portal
            </a>
            <a href="/receptionist-dashboard" target="_blank" class="btn btn-warning">
                ğŸ¢ Open Receptionist Dashboard
            </a>
        </div>

        <!-- Real-time Event Log -->
        <div class="section">
            <h2>ğŸ“¡ Real-time Event Log</h2>
            <div id="eventLogs" class="logs"></div>
            <button class="btn btn-primary" onclick="clearLogs()" style="margin-top: 10px;">ğŸ§¹ Clear Logs</button>
        </div>
    </div>

    <script>
        // Import the unified appointments system
        const UNIFIED_STORAGE_KEY = 'unified_appointments';
        const DR_SMITH_ID = '5fe10688-b38e-458e-b38b-bf8a2507b19a';
        const DR_BROWN_ID = '9049628e-cd05-4bd6-b08e-ee923c6dec10';
        const SARAH_WILLIAMS_ID = 'patient-2';
        const JOHN_DOE_ID = 'patient-1';
        
        function log(message, type = 'info') {
            const logs = document.getElementById('eventLogs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function getUnifiedAppointments() {
            try {
                let data = localStorage.getItem(UNIFIED_STORAGE_KEY);
                if (!data) data = sessionStorage.getItem(UNIFIED_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                log(`âŒ Error reading appointments: ${error.message}`, 'error');
                return [];
            }
        }
        
        function saveUnifiedAppointments(appointments) {
            try {
                const data = JSON.stringify(appointments);
                localStorage.setItem(UNIFIED_STORAGE_KEY, data);
                sessionStorage.setItem(UNIFIED_STORAGE_KEY, data);
                
                // Broadcast sync event
                const syncEvent = new CustomEvent('appointmentSyncEvent', { 
                    detail: { appointments, timestamp: Date.now() } 
                });
                window.dispatchEvent(syncEvent);
                
                log(`ğŸ’¾ Saved ${appointments.length} appointments to storage`, 'success');
                return true;
            } catch (error) {
                log(`âŒ Error saving appointments: ${error.message}`, 'error');
                return false;
            }
        }
        
        function createUnifiedAppointment(data) {
            const appointments = getUnifiedAppointments();
            
            const newAppointment = {
                id: `unified_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                createdAt: new Date().toISOString(),
                status: 'scheduled',
                priority: 'normal',
                tenantId: 'metro-general',
                ...data
            };
            
            appointments.push(newAppointment);
            saveUnifiedAppointments(appointments);
            
            log(`ğŸš€ Created appointment: ${newAppointment.patientName} â†’ ${newAppointment.doctorName}`, 'success');
            log(`ğŸ“… Date: ${newAppointment.date} at ${newAppointment.time}`, 'info');
            log(`ğŸ‘¤ Created by: ${newAppointment.createdBy}`, 'info');
            
            refreshStats();
            displayAppointments();
            
            return newAppointment.id;
        }
        
        // Test appointment creators
        function createPatientAppointment() {
            log('ğŸ“± Creating appointment from Patient Portal...', 'info');
            createUnifiedAppointment({
                patientId: SARAH_WILLIAMS_ID,
                patientName: 'Sarah Williams',
                patientEmail: 'sarah.williams@email.com',
                patientPhone: '(555) 234-5678',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                doctorSpecialization: 'Internal Medicine',
                date: '2025-08-13',
                time: '14:30',
                type: 'Consultation',
                reason: 'Follow-up appointment for test results',
                createdBy: 'patient',
                createdById: SARAH_WILLIAMS_ID
            });
        }
        
        function createPatientAppointmentDifferentDoctor() {
            log('ğŸ“± Creating appointment with different doctor from Patient Portal...', 'info');
            createUnifiedAppointment({
                patientId: SARAH_WILLIAMS_ID,
                patientName: 'Sarah Williams',
                patientEmail: 'sarah.williams@email.com',
                patientPhone: '(555) 234-5678',
                doctorId: DR_BROWN_ID,
                doctorName: 'Dr. Emily Brown',
                doctorSpecialization: 'Cardiology',
                date: '2025-08-14',
                time: '10:00',
                type: 'Specialist Consultation',
                reason: 'Heart palpitations evaluation',
                createdBy: 'patient',
                createdById: SARAH_WILLIAMS_ID
            });
        }
        
        function createDoctorAppointment() {
            log('ğŸ©º Creating appointment from Doctor Portal...', 'info');
            createUnifiedAppointment({
                patientId: JOHN_DOE_ID,
                patientName: 'John Doe',
                patientEmail: 'john.doe@email.com',
                patientPhone: '(555) 123-4567',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                doctorSpecialization: 'Internal Medicine',
                date: '2025-08-13',
                time: '16:00',
                type: 'Physical Examination',
                reason: 'Annual physical checkup',
                createdBy: 'doctor',
                createdById: DR_SMITH_ID
            });
        }
        
        function createDoctorEmergencyAppointment() {
            log('ğŸš¨ Creating emergency appointment from Doctor Portal...', 'warning');
            createUnifiedAppointment({
                patientId: 'patient-3',
                patientName: 'Michael Johnson',
                patientEmail: 'michael.johnson@email.com',
                patientPhone: '(555) 345-6789',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                doctorSpecialization: 'Internal Medicine',
                date: '2025-08-13',
                time: '12:00',
                type: 'Emergency',
                reason: 'Severe abdominal pain - immediate attention required',
                priority: 'urgent',
                createdBy: 'doctor',
                createdById: DR_SMITH_ID
            });
        }
        
        function createReceptionistAppointment() {
            log('ğŸ“‹ Creating appointment from Receptionist Dashboard...', 'info');
            createUnifiedAppointment({
                patientId: 'patient-4',
                patientName: 'Emily Brown',
                patientEmail: 'emily.brown@email.com',
                patientPhone: '(555) 456-7890',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                doctorSpecialization: 'Internal Medicine',
                date: '2025-08-14',
                time: '09:00',
                type: 'Consultation',
                reason: 'Patient called to schedule routine checkup',
                createdBy: 'receptionist',
                createdById: 'receptionist-001'
            });
        }
        
        function createReceptionistUrgentAppointment() {
            log('âš ï¸ Creating urgent appointment from Receptionist Dashboard...', 'warning');
            createUnifiedAppointment({
                patientId: 'patient-5',
                patientName: 'James Wilson',
                patientEmail: 'james.wilson@email.com',
                patientPhone: '(555) 567-8901',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                doctorSpecialization: 'Internal Medicine',
                date: '2025-08-13',
                time: '13:00',
                type: 'Urgent Care',
                reason: 'Patient experiencing chest discomfort - needs immediate evaluation',
                priority: 'high',
                createdBy: 'receptionist',
                createdById: 'receptionist-001'
            });
        }
        
        function refreshStats() {
            const appointments = getUnifiedAppointments();
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('totalCount').textContent = appointments.length;
            document.getElementById('drSmithCount').textContent = appointments.filter(apt => apt.doctorId === DR_SMITH_ID).length;
            document.getElementById('sarahCount').textContent = appointments.filter(apt => apt.patientId === SARAH_WILLIAMS_ID).length;
            document.getElementById('todayCount').textContent = appointments.filter(apt => apt.date === today).length;
            
            log(`ğŸ“Š Statistics updated: ${appointments.length} total appointments`, 'info');
        }
        
        function displayAppointments() {
            const appointments = getUnifiedAppointments();
            const container = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No appointments found. Create some using the buttons above!</p>';
                return;
            }
            
            // Sort by date and time
            const sorted = appointments.sort((a, b) => {
                const dateTimeA = new Date(a.date + 'T' + a.time);
                const dateTimeB = new Date(b.date + 'T' + b.time);
                return dateTimeA - dateTimeB;
            });
            
            container.innerHTML = sorted.map(apt => `
                <div class="appointment-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; color: #2d3748;">${apt.patientName} â†’ ${apt.doctorName}</h3>
                            <p style="margin: 0 0 5px 0;"><strong>Type:</strong> ${apt.type} | <strong>Reason:</strong> ${apt.reason}</p>
                            <p style="margin: 0 0 5px 0;"><strong>Date:</strong> ${new Date(apt.date + 'T' + apt.time).toLocaleString()}</p>
                            <div class="appointment-meta">
                                <span>Created by: <strong>${apt.createdBy}</strong></span> | 
                                <span>Priority: <strong>${apt.priority}</strong></span> | 
                                <span>Status: <strong>${apt.status}</strong></span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8em; color: #718096; margin-bottom: 5px;">ID: ${apt.id}</div>
                            <div style="font-size: 0.75em; color: #a0aec0;">Created: ${new Date(apt.createdAt).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            log(`ğŸ“‹ Displayed ${sorted.length} appointments`, 'info');
        }
        
        function clearAllAppointments() {
            if (confirm('âš ï¸ Are you sure you want to clear ALL appointments? This cannot be undone.')) {
                localStorage.removeItem(UNIFIED_STORAGE_KEY);
                sessionStorage.removeItem(UNIFIED_STORAGE_KEY);
                localStorage.removeItem('realtime_appointments');
                localStorage.removeItem('nav_appointments');
                localStorage.removeItem('appointment_backup');
                
                log('ğŸ—‘ï¸ All appointments cleared from storage', 'warning');
                refreshStats();
                displayAppointments();
                
                // Broadcast clear event
                window.dispatchEvent(new CustomEvent('appointmentSyncEvent', { 
                    detail: { appointments: [], timestamp: Date.now() } 
                }));
            }
        }
        
        function clearLogs() {
            document.getElementById('eventLogs').innerHTML = '';
        }
        
        // Listen for real-time events
        window.addEventListener('appointmentSyncEvent', (event) => {
            log(`ğŸ“¨ Received sync event: ${event.detail.appointments.length} appointments`, 'success');
            refreshStats();
            displayAppointments();
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ¯ Unified Appointment Test System Loaded', 'success');
            log(`ğŸ‘¨â€âš•ï¸ Dr. Smith ID: ${DR_SMITH_ID}`, 'info');
            log(`ğŸ‘¤ Sarah Williams ID: ${SARAH_WILLIAMS_ID}`, 'info');
            refreshStats();
            displayAppointments();
        });
    </script>
</body>
</html>