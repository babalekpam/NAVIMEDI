<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Sync Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .logs { background: #f5f5f5; padding: 10px; max-height: 200px; overflow-y: auto; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>ðŸ”„ Real-Time Appointment Sync Debug</h1>
    
    <div class="section">
        <h2>Current Storage Status</h2>
        <div id="storageStatus"></div>
        <button onclick="refreshStatus()">Refresh Status</button>
        <button onclick="clearAllStorage()">Clear All Storage</button>
    </div>
    
    <div class="section">
        <h2>Test Actions</h2>
        <button onclick="addDrSmithAppointment()">Add Test Appointment for Dr. Smith</button>
        <button onclick="viewDrSmithAppointments()">View Dr. Smith Appointments</button>
        <button onclick="testRealTimeEvent()">Test Real-Time Event</button>
    </div>
    
    <div class="section">
        <h2>Event Logs</h2>
        <div id="logs" class="logs"></div>
    </div>
    
    <script>
        const STORAGE_KEY = 'realtime_appointments';
        const BACKUP_KEY = 'appointment_backup';
        const DR_SMITH_ID = '5fe10688-b38e-458e-b38b-bf8a2507b19a';
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function refreshStatus() {
            const localStorage = window.localStorage.getItem(STORAGE_KEY);
            const sessionStorage = window.sessionStorage.getItem(STORAGE_KEY);
            const backup = window.localStorage.getItem(BACKUP_KEY);
            
            const statusDiv = document.getElementById('storageStatus');
            statusDiv.innerHTML = `
                <p><strong>localStorage (realtime_appointments):</strong> ${localStorage ? JSON.parse(localStorage).length + ' appointments' : 'None'}</p>
                <p><strong>sessionStorage (realtime_appointments):</strong> ${sessionStorage ? JSON.parse(sessionStorage).length + ' appointments' : 'None'}</p>
                <p><strong>localStorage (backup):</strong> ${backup ? JSON.parse(backup).length + ' appointments' : 'None'}</p>
                <hr>
                <details>
                    <summary>Raw Data</summary>
                    <pre>localStorage: ${localStorage || 'null'}
sessionStorage: ${sessionStorage || 'null'}
backup: ${backup || 'null'}</pre>
                </details>
            `;
            
            log(`ðŸ“Š Storage status refreshed`);
        }
        
        function clearAllStorage() {
            localStorage.removeItem(STORAGE_KEY);
            sessionStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(BACKUP_KEY);
            localStorage.removeItem('nav_appointments'); // Old key
            
            // Fire clear event
            window.dispatchEvent(new CustomEvent('appointmentsCleared'));
            
            log(`ðŸ—‘ï¸ All storage cleared`);
            refreshStatus();
        }
        
        function addDrSmithAppointment() {
            const appointments = getAppointments();
            const newAppointment = {
                id: `debug_${Date.now()}`,
                patientId: 'patient-2',
                patientName: 'Sarah Williams',
                doctorId: DR_SMITH_ID,
                doctorName: 'Dr. Michael Smith',
                date: '2025-08-13',
                time: '14:30',
                type: 'Debug Test',
                reason: 'Testing real-time synchronization',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            appointments.push(newAppointment);
            saveAppointments(appointments);
            
            // Fire events
            const customEvent = new CustomEvent('appointmentAdded', { detail: newAppointment });
            window.dispatchEvent(customEvent);
            
            log(`âœ… Added test appointment: ${newAppointment.id}`);
            log(`ðŸŽ¯ Doctor ID: ${newAppointment.doctorId}`);
            refreshStatus();
        }
        
        function viewDrSmithAppointments() {
            const appointments = getAppointments();
            const drSmithAppts = appointments.filter(apt => apt.doctorId === DR_SMITH_ID);
            
            log(`ðŸ‘¨â€âš•ï¸ Dr. Smith has ${drSmithAppts.length} appointments:`);
            drSmithAppts.forEach(apt => {
                log(`  - ${apt.patientName} on ${apt.date} at ${apt.time} (${apt.type})`);
            });
            
            if (drSmithAppts.length === 0) {
                log(`âŒ No appointments found for Dr. Smith (${DR_SMITH_ID})`);
            }
        }
        
        function testRealTimeEvent() {
            log(`ðŸš€ Testing real-time event broadcast...`);
            
            const testEvent = new CustomEvent('appointmentAdded', {
                detail: { test: 'real-time sync test', timestamp: Date.now() }
            });
            
            window.dispatchEvent(testEvent);
            log(`ðŸ“¡ Event dispatched successfully`);
        }
        
        function getAppointments() {
            let data = localStorage.getItem(STORAGE_KEY);
            if (!data) data = sessionStorage.getItem(STORAGE_KEY);
            if (!data) data = localStorage.getItem(BACKUP_KEY);
            
            return data ? JSON.parse(data) : [];
        }
        
        function saveAppointments(appointments) {
            const data = JSON.stringify(appointments);
            localStorage.setItem(STORAGE_KEY, data);
            sessionStorage.setItem(STORAGE_KEY, data);
            localStorage.setItem(BACKUP_KEY, data);
        }
        
        // Listen for events
        window.addEventListener('appointmentAdded', (event) => {
            log(`ðŸ“¨ Received appointmentAdded event: ${JSON.stringify(event.detail)}`);
        });
        
        window.addEventListener('appointmentsCleared', (event) => {
            log(`ðŸ“¨ Received appointmentsCleared event`);
        });
        
        // Initial load
        refreshStatus();
        log(`ðŸŽ¯ Debug page loaded. Dr. Smith ID: ${DR_SMITH_ID}`);
    </script>
</body>
</html>